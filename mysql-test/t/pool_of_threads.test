# Start with threadpool plugin loaded
# and run a number of tests

--source include/have_pool_of_threads.inc
--source include/common-tests.inc

SELECT @@threadpool_size;
SELECT @@threadpool_max_threads;

# Test that we cannot have more simultaneous connections than
# --thread-pool-size
call mtr.add_suppression("Threadpool could not create additional thread to handle queries");

# First set two connections running, and check that extra connection
# fail due to --threadpool_max_threads=2
connection default;
let $default_id = `select connection_id()`;
send SELECT sleep(5);

connect(con2,localhost,root,,);
connection con2;
let $con2_id = `select connection_id()`;
send SELECT sleep(50000);
--sleep  2.5

--disable_abort_on_error
--disable_result_log
--disable_query_log
connect(con3,localhost,root,,);
--enable_query_log
--enable_result_log
--enable_abort_on_error
let $error = $mysql_errno;
if (!$error)
{
  --echo # -- Error: managed to establish more than --thread_pool_max_threads connections
}
if ($error)
{
  --echo # -- Success: more than --thread_pool_max_threads normal connections not possible
}

connection default;
--reap
let @ignore = `select @id := $con2_id`;
KILL QUERY @id;
connection con2;
--reap
